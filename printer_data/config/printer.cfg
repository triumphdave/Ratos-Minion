#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
### Everything below [include RatOS.cfg] will override default RatOS behavior
#############################################################################################################
[include RatOS.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "front"
variable_start_print_park_z_height: 25
variable_end_print_park_in: "back"
variable_pause_print_park_in: "front"

#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-z-offset
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering 
### input shaper configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

#---------------------------------------------------- X -----------------------------------------------------
# The X axis motor moves the print head left and right.
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: x_dir_pin       # Remove ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -2
position_max: 180
position_endstop: -2

#---------------------------------------------------- Y -----------------------------------------------------
# The Y axis motor moves the print bed forward and backward.
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: !y_dir_pin       # Remove ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -2
position_max: 180
position_endstop: -1

#---------------------------------------------------- Z -----------------------------------------------------
# The Z axis motor moves the print head up and down.
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: z0_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 40     # 4 for TR8*4 lead screws
gear_ratio: 40:1          
homing_speed: 5
position_min: -5
position_max: 175

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for your toolhead
#------------------------------------------------------------------------------------------------------------
[extruder]
max_temp: 300
dir_pin: e_dir_pin       # Remove ! in front of pin name to reverse the direction of extruder
rotation_distance: 4.63   # Orbiter 2 default
#pressure_advance: 0.05   # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
#control: pid
#pid_kp: 21.673
#pid_ki: 1.338
#pid_kd: 87.776


[heater_bed]
#control: pid
#pid_kp: 68.203
#pid_ki: 2.842
#pid_kd: 409.216

# Probe configuration
[probe]
#z_offset: 0.0 # Will be commented out after a successful PROBE_CALIBRATE and SAVE_CONFIG
pin: ^probe_pin# For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.
x_offset: -23
y_offset: -10
speed: 8
sample_retract_dist: 2
lift_speed: 40
#pin: ^!probe_pin # NPN NO (refer to the specs of your probe)
#pin: probe_pin # PNP NO (refer to the specs of your probe)
#pin: !probe_pin # PNP NC (refer to the specs of your probe)


[controller_fan controller_fan]
max_power: 0.4

[ratos]
allow_unsupported_slicer_versions: True

[gcode_macro COLD_PULL]
description: Perform a cold pull at the selected temperature
#default_parameter_temp: 150
gcode:
    M117 Starting cold pull...
    M104 S{temp}         ; Set nozzle temperature
    M190 S40             ; Set bed temperature (low enough to cool the part, adjust if necessary)
    G4 S30               ; Wait for 30 seconds to stabilize nozzle temp
    M117 Heating nozzle to {temp}...
    G90                  ; Use absolute positioning
    G92 E0               ; Reset extruder position
    G1 E5 F100           ; Prime nozzle
    G4 S5                ; Hold extrusion for 5 seconds
    M104 S120            ; Cool nozzle to cold pull temp (120Â°C is typical for cold pull)
    G4 S60               ; Wait for nozzle to cool down
    M117 Cooling nozzle...
    G1 E-5 F500          ; Retract filament slightly to release pressure
    G4 S5                ; Pause briefly before pulling
    M117 Pull filament now!
    M104 S0              ; Turn off nozzle
    M140 S0              ; Turn off bed
    M117 Cold pull complete.
    
###################################################################

#[input_shaper]
#shaper_freq_x: 75.2
#shaper_type_x: zv
#shaper_freq_y: 55.8
#shaper_type_y: zv

############################

# REMEMBER TO TUNE SENSORLESS HOMING BEFORE ATTEMPTING TO PRINT!
# You'll find instructions in the generated sensorless-homing-*.cfg file(s),
# where you should keep your sensorless homing settings.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = -0.150
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.298
#*# pid_ki = 1.916
#*# pid_kd = 97.250
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 63.869
#*# pid_ki = 2.678
#*# pid_kd = 380.821
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	  0.094766, 0.041172, -0.124375, 0.017656
#*# 	  0.062031, -0.012109, -0.136172, -0.248828
#*# 	  0.066484, -0.017266, -0.168438, -0.250234
#*# 	  0.099531, 0.004922, -0.123672, -0.108594
#*# x_count = 4
#*# y_count = 4
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 28.00659999999999
#*# max_x = 149.98659999999998
#*# min_y = 27.9852
#*# max_y = 151.9752
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.077031, 0.154141, 0.205781, 0.328984, 0.393750
#*# 	0.716406, 0.610391, 0.501406, 0.471641, 0.399687
#*# 	0.776406, 0.794062, 0.796875, 0.891172, 0.934844
#*# 	1.356250, 1.250000, 1.134766, 1.083516, 0.981016
#*# 	1.465703, 1.459375, 1.457891, 1.547656, 1.591172
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 150.0
#*# min_y = 15.0
#*# max_y = 160.0
