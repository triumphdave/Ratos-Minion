# WARNING. THIS FILE IS GENERATED BY THE RATOS CONFIGURATOR.
# CHANGES YOU MAKE HERE WILL BE OVERWRITTEN. KEEP YOUR CHANGES IN PRINTER.CFG.
# Config generated for Rat Rig V-Minion
# Documentation: https://os.ratrig.com

#############################################################################################################
### CONTROLBOARD & TOOLBOARD
#############################################################################################################
[include RatOS/boards/rpi/config.cfg]

[board_pins btt-skr-mini-e3-30]
aliases:
	#----------------------------------------------- X motor pins -----------------------------------------------
	# Assigned to slot: "X"
	#------------------------------------------------------------------------------------------------------------
	x_step_pin=PB13,
	x_dir_pin=PB12,
	x_enable_pin=PB14,
	x_uart_pin=PC11,
	x_diag_pin=PC0,
	x_endstop_pin=PC0,
	#----------------------------------------------- Y motor pins -----------------------------------------------
	# Assigned to slot: "Y"
	#------------------------------------------------------------------------------------------------------------
	y_step_pin=PB10,
	y_dir_pin=PB2,
	y_enable_pin=PB11,
	y_uart_pin=PC11,
	y_diag_pin=PC1,
	y_endstop_pin=PC1,
	#----------------------------------------------- Z motor pins -----------------------------------------------
	# Assigned to slot: "Z"
	#------------------------------------------------------------------------------------------------------------
	z0_step_pin=PB0,
	z0_dir_pin=PC5,
	z0_enable_pin=PB1,
	z0_uart_pin=PC11,
	z0_diag_pin=PC2,
	#------------------------------------------- EXTRUDER motor pins --------------------------------------------
	# Assigned to slot: "E0"
	#------------------------------------------------------------------------------------------------------------
	e_step_pin=PB3,
	e_dir_pin=PB4,
	e_enable_pin=PD1,
	e_uart_pin=PC11,
	e_diag_pin=PC15,
	#----------------------------------------------- GENERAL PINS -----------------------------------------------
	e_heater_pin=PC8,
	e_sensor_pin=PA0,
	stepper_spi_mosi_pin=null,
	stepper_spi_miso_pin=null,
	stepper_spi_sclk_pin=null,
	adxl345_cs_pin=PD0,
	bltouch_sensor_pin=PC14,
	bltouch_control_pin=PA1,
	probe_pin=PC14,
	fan_part_cooling_pin=PC6,
	fan_toolhead_cooling_pin=PC7,
	fan_controller_board_pin=PB15,
	heater_bed_heating_pin=PC9,
	heater_bed_sensor_pin=PC4,
	4p_fan_part_cooling_pin=null,
	4p_fan_part_cooling_tach_pin=null,
	4p_toolhead_cooling_pin=null,
	4p_toolhead_cooling_tach_pin=null,
	4p_controller_board_pin=null,
	4p_controller_board_tach_pin=null

[mcu]
serial: /dev/RatOS/btt-skr-mini-e3-30

[temperature_sensor SKR_Mini_E3_V3.0]
sensor_type: temperature_mcu

[adxl345 controlboard]
cs_pin: PD0
spi_software_mosi_pin: PD3
spi_software_miso_pin: PD4
spi_software_sclk_pin: PD2


#############################################################################################################
### BASE SETUP
#############################################################################################################
[include RatOS/homing.cfg]
[include RatOS/macros.cfg]
[include RatOS/shell-macros.cfg]
[include RatOS/printers/v-minion/v-minion.cfg]
[include RatOS/printers/v-minion/macros.cfg]

# Extruder
# T0 Orbiter 2 definition (from RatOS/extruders/orbiter-2.cfg)
[extruder]
rotation_distance: 4.63
full_steps_per_rotation: 200
filament_diameter: 1.750
max_extrude_only_velocity: 60

[firmware_retraction]
retract_speed: 60
unretract_extra_length: 0
unretract_speed: 60

# Hotend
# T0 Phaetus Dragon HF definition (from RatOS/hotends/dragon-high-flow.cfg)
[extruder]
max_extrude_only_distance: 200
nozzle_diameter: 0.4
heater_pin: PC8
sensor_type: Generic 3950
sensor_pin: PA0
min_extrude_temp: 170
min_temp: 0
max_temp: 285
pressure_advance: 0.03

[firmware_retraction]
retract_length: 0.5

# ADXL345 resonance testing configuration
[resonance_tester]
accel_chip_x: adxl345 controlboard
accel_chip_y: adxl345 controlboard
probe_points:
	90,90,20


#############################################################################################################
### STEPPER MOTORS, DRIVERS & SPEED LIMITS
#############################################################################################################
#---------------------------------------------------- X -----------------------------------------------------
# The X axis motor moves the print head left and right.
# Connected to X on BIGTREETECH SKR Mini E3 V3.0
# Driver: BTT TMC2209 v1.3
# Motor: LDO-42STH40-1684AC
# Voltage: 24
#------------------------------------------------------------------------------------------------------------
[tmc2209 stepper_x]
stealthchop_threshold: 0
interpolate: False
uart_pin: PC11
tx_pin: PC10
run_current: 0.8
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 3
driver_HSTRT: 0
sense_resistor: 0.11

[stepper_x]
step_pin: PB13
dir_pin: PB12
enable_pin: !PB14
microsteps: 64
full_steps_per_rotation: 200
rotation_distance: 40
homing_speed: 50

#---------------------------------------------------- Y -----------------------------------------------------
# The Y axis motor moves the print bed forward and backward.
# Connected to Y on BIGTREETECH SKR Mini E3 V3.0
# Driver: BTT TMC2209 v1.3
# Motor: LDO-42STH40-1684AC
# Voltage: 24
#------------------------------------------------------------------------------------------------------------
[tmc2209 stepper_y]
stealthchop_threshold: 0
interpolate: False
uart_pin: PC11
tx_pin: PC10
run_current: 0.8
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 3
driver_HSTRT: 0
sense_resistor: 0.11

[stepper_y]
step_pin: PB10
dir_pin: PB2
enable_pin: !PB11
microsteps: 64
full_steps_per_rotation: 200
rotation_distance: 40
homing_speed: 50

#---------------------------------------------------- Z -----------------------------------------------------
# The Z axis motor moves the print head up and down.
# Connected to Z on BIGTREETECH SKR Mini E3 V3.0
# Driver: BTT TMC2209 v1.3
# Motor: LDO-42STH40-1684AC
# Voltage: 24
#------------------------------------------------------------------------------------------------------------
[tmc2209 stepper_z]
stealthchop_threshold: 0
interpolate: False
uart_pin: PC11
tx_pin: PC10
run_current: 0.8
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 3
driver_HSTRT: 0
sense_resistor: 0.11

[stepper_z]
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
microsteps: 64
full_steps_per_rotation: 200
rotation_distance: 4
position_min: -5
homing_speed: 10
endstop_pin: probe:z_virtual_endstop

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for your toolhead
# Connected to E0 on BIGTREETECH SKR Mini E3 V3.0
# Driver: BTT TMC2209 v1.3
# Motor: LDO-36STH20-1004AHG
# Voltage: 24
#------------------------------------------------------------------------------------------------------------
[tmc2209 extruder]
stealthchop_threshold: 0
interpolate: False
uart_pin: PC11
tx_pin: PC10
run_current: 0.707
driver_TBL: 0
driver_TOFF: 4
driver_HEND: 6
driver_HSTRT: 7
sense_resistor: 0.11

[extruder]
step_pin: PB3
dir_pin: PB4
enable_pin: !PD1
microsteps: 64
full_steps_per_rotation: 200
rotation_distance: 4.63

# Include controlboard quirk file
[include RatOS/boards/btt-skr-mini-e3-30/quirks.cfg]
[printer]
max_velocity: 200
max_accel: 3000
minimum_cruise_ratio: 0.5
max_z_velocity: 15
max_z_accel: 200
square_corner_velocity: 5

[gcode_macro RatOS]
variable_macro_travel_speed: 200
variable_macro_travel_accel: 3000

[bed_mesh]
speed: 200


#############################################################################################################
### HOMING
#############################################################################################################
[include RatOS/z-probe/superpinda.cfg]
# Probe configuration
[probe]
pin: ^PC14# For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.

[include sensorless-homing-x.cfg]
[include sensorless-homing-y.cfg]


#############################################################################################################
### FANS
#############################################################################################################
# Part cooling fan
[fan]
# 2-pin fan connected to 2-pin header on SKR Mini E3 V3.0 - input voltage pwm
pin: PC6

# Hotend cooling fan
[heater_fan toolhead_cooling_fan]
heater: extruder
# 2-pin fan connected to 2-pin header on SKR Mini E3 V3.0 - input voltage pwm
pin: PC7

# Controller cooling fan
[controller_fan controller_fan]
# 2-pin fan connected to 2-pin header on SKR Mini E3 V3.0 - input voltage pwm
pin: PB15

#############################################################################################################
### MACRO CONFIGURATION
#############################################################################################################
[gcode_macro T0]
variable_join: 0
variable_remap: 0
variable_alert: ""
variable_filament_name: ""
variable_filament_type: ""
variable_filament_temp: 0
variable_runout_sensor: ""
variable_active: True
variable_color: "7bff33"                                  # Used in frontends
variable_hotend_type: "HF"
variable_has_cht_nozzle: False
variable_cooling_position_to_nozzle_distance: 40          # heatbreak length from cold zone to nozzle
variable_tooolhead_sensor_to_extruder_gear_distance: 15   # distance in mm from the sensor to the extruder gear
variable_extruder_gear_to_cooling_position_distance: 30   # distance in mm from the extruder gear to the end of the hotend cold zone
variable_filament_loading_nozzle_offset: -5
variable_filament_grabbing_length: 5
variable_filament_grabbing_speed: 1
variable_enable_insert_detection: True                    # enables filament sensor insert detection 
variable_enable_runout_detection: True                    # enables filament sensor runout detection 
variable_enable_clog_detection: True                      # enables filament sensor clog detection 
variable_unload_after_runout: True                        # unload filament after a runout has been detected
variable_purge_after_load: 0
variable_purge_before_unload: 0
variable_extruder_load_speed: 60
variable_filament_load_speed: 10
variable_standby: False
variable_temperature_offset: 0                            # hotend temperature offset
variable_has_oozeguard: False                             # toolhead has a oozeguard
variable_has_front_arm_nozzle_wiper: False                # toolhead has front arm nozzle wipers
variable_resume_after_insert: False                       # resumes the print after inserting new filament
gcode:
	{% set x = params.X|default(-1.0)|float %}
	{% set y = params.Y|default(-1.0)|float %}
	{% set z = params.Z|default(0.0)|float %}
	{% set s = params.S|default(1)|int %}
	{% if printer["gcode_macro _SELECT_TOOL"] is defined %}
		_SELECT_TOOL T=0 X={x} Y={y} Z={z} TOOLSHIFT={s}
	{% endif %}

# Macro variable overrides
[gcode_macro RatOS]
variable_bed_margin_x: [0, 0]
variable_bed_margin_y: [0, 0]
variable_x_driver_types: ["tmc2209"]
variable_x_axes: ["x"]
variable_y_driver_types: ["tmc2209"]
variable_y_axes: ["y"]
variable_z_driver_types: ["tmc2209"]
variable_z_axes: ["z"]

# Save variables
[save_variables]
filename: /home/pi/printer_data/config/ratos-variables.cfg